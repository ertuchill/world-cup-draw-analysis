<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Cup 2026 - Draw Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color: white; min-height: 100vh; }
        h1, h2 { font-family: 'Oswald', sans-serif; text-transform: uppercase; }
        .btn-action { transition: all 0.3s ease; cursor: pointer; }
        .btn-action:hover { transform: translateY(-2px); }
        .group-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: transform 0.3s ease; }
        .group-card:hover { transform: scale(1.02); border-color: #ca8a04; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #ca8a04; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col items-center py-8 px-4">

    <header class="text-center mb-8 flex items-center justify-center gap-4">
        <i class="fas fa-trophy text-4xl text-yellow-500"></i>
        <div>
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-600">WORLD CUP 2026</h1>
            <p class="text-gray-400 text-sm tracking-widest">OFFICIAL DRAW RESULTS</p>
        </div>
    </header>

    <div class="flex flex-wrap justify-center gap-4 mb-10 w-full max-w-4xl">
        <a href="/" class="btn-action bg-gray-700 text-white px-6 py-3 rounded-full font-bold flex items-center gap-2 border border-gray-600 hover:bg-gray-600">
            <i class="fas fa-arrow-left"></i> BACK TO SETTINGS
        </a>
        <button onclick="performDraw()" class="btn-action bg-gradient-to-r from-yellow-600 to-yellow-500 text-black px-8 py-3 rounded-full font-bold flex items-center gap-2 shadow-lg">
            <i class="fas fa-sync-alt"></i> DRAW AGAIN
        </button>
    </div>

    <div id="loader" class="loader"></div>
    <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full max-w-7xl"></div>

    <script>
        // Flag Mapping
        const flagMap = {
            "Mexico": "mx", "Canada": "ca", "USA": "us", "Spain": "es", "Argentina": "ar", "France": "fr", "England": "gb-eng", "Brazil": "br", "Portugal": "pt", "Netherlands": "nl", "Belgium": "be", "Germany": "de",
            "Croatia": "hr", "Morocco": "ma", "Colombia": "co", "Uruguay": "uy", "Switzerland": "ch", "Japan": "jp", "Senegal": "sn", "IR Iran": "ir", "Korea Republic": "kr", "Ecuador": "ec", "Austria": "at", "Australia": "au",
            "Norway": "no", "Panama": "pa", "Egypt": "eg", "Algeria": "dz", "Scotland": "gb-sct", "Paraguay": "py", "Tunisia": "tn", "Côte d'Ivoire": "ci", "Uzbekistan": "uz", "Qatar": "qa", "Saudi Arabia": "sa", "South Africa": "za",
            "Jordan": "jo", "Cabo Verde": "cv", "Ghana": "gh", "Curaçao": "cw", "Haiti": "ht", "New Zealand": "nz",
            "Italy": "it", "N. Ireland": "gb-nir", "Wales": "gb-wls", "Bosnia": "ba", "Bosnia & Herz.": "ba",
            "Ukraine": "ua", "Sweden": "se", "Poland": "pl", "Albania": "al",
            "Türkiye": "tr", "Turkey": "tr", "Romania": "ro", "Slovakia": "sk", "Kosovo": "xk",
            "Denmark": "dk", "N. Macedonia": "mk", "Czechia": "cz", "Ireland": "ie",
            "Jamaica": "jm", "DR Congo": "cd", "New Caledonia": "nc",
            "Iraq": "iq", "Bolivia": "bo", "Suriname": "sr"
        };

        window.onload = performDraw;

        async function performDraw() {
            const container = document.getElementById('groups-container');
            const loader = document.getElementById('loader');
            const redrawBtn = document.querySelector('button[onclick="performDraw()"]');
            
            if(redrawBtn) { redrawBtn.disabled = true; redrawBtn.classList.add('opacity-50', 'cursor-not-allowed'); }
            
            container.innerHTML = '';
            loader.style.display = 'block';

            const savedSelections = localStorage.getItem('wc2026_selections');
            if (!savedSelections) { window.location.href = '/'; return; }

            const selections = JSON.parse(savedSelections);
            const finalPlayoffWinners = [];
            const ids = ['po-a', 'po-b', 'po-c', 'po-d', 'po-f1', 'po-f2'];
            
            // Random selection logic handled here for safety
            // (Assuming hidden data divs are removed or handled differently, logic simplified for brevity)
            // Note: Since we removed the hidden div block from this clean version, 
            // we will rely on the backend dummy fallback if "random" is sent, OR handle random here if needed.
            // For a robust clean code, we send what we have. If value is "random", backend handles it or we pick here.
            // Let's implement a simple client-side random picker if "random" is selected to keep consistency.
            
            // Define pools for client-side randomization
            const pools = {
                "po-a": [{isim:"Italy",kita:"EU"},{isim:"N. Ireland",kita:"EU"},{isim:"Wales",kita:"EU"},{isim:"Bosnia",kita:"EU"}],
                "po-b": [{isim:"Ukraine",kita:"EU"},{isim:"Sweden",kita:"EU"},{isim:"Poland",kita:"EU"},{isim:"Albania",kita:"EU"}],
                "po-c": [{isim:"Türkiye",kita:"EU"},{isim:"Romania",kita:"EU"},{isim:"Slovakia",kita:"EU"},{isim:"Kosovo",kita:"EU"}],
                "po-d": [{isim:"Denmark",kita:"EU"},{isim:"N. Macedonia",kita:"EU"},{isim:"Czechia",kita:"EU"},{isim:"Ireland",kita:"EU"}],
                "po-f1": [{isim:"Jamaica",kita:"NA"},{isim:"DR Congo",kita:"AF"},{isim:"New Caledonia",kita:"OC"}],
                "po-f2": [{isim:"Iraq",kita:"AS"},{isim:"Bolivia",kita:"SA"},{isim:"Suriname",kita:"NA"}]
            };

            ids.forEach(id => {
                if (selections[id] === 'random') {
                    const pool = pools[id];
                    const randomPick = pool[Math.floor(Math.random() * pool.length)];
                    // Convert frontend 'kita' string to backend list format
                    finalPlayoffWinners.push({isim: randomPick.isim, kitalar: [randomPick.kita]});
                } else {
                    const parsed = JSON.parse(selections[id]);
                    // Ensure format match
                    if(!parsed.kitalar) parsed.kitalar = [parsed.kita]; 
                    finalPlayoffWinners.push(parsed);
                }
            });

            try {
                const response = await fetch('/api/draw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playoff_winners: finalPlayoffWinners })
                });

                if (!response.ok) throw new Error("Server Error");
                const groups = await response.json();

                if(groups.error) {
                    alert(groups.error);
                    loader.style.display = 'none';
                    if(redrawBtn) { redrawBtn.disabled = false; redrawBtn.classList.remove('opacity-50', 'cursor-not-allowed'); }
                    return;
                }

                loader.style.display = 'none';

                groups.forEach((group, index) => {
                    setTimeout(() => {
                        const card = document.createElement('div');
                        card.className = 'group-card p-5 rounded-xl fade-in';
                        let teamsHtml = '';
                        
                        group.teams.forEach((team, i) => {
                            let specialClass = "text-gray-200";
                            let starIcon = "";
                            let flagCode = flagMap[team.isim];
                            let visualHtml = flagCode ? `<img src="https://flagcdn.com/w20/${flagCode}.png" class="w-5 h-3.5 object-cover rounded-[1px] shadow-sm mr-2">` : `<i class="fas fa-users text-gray-500 mr-2"></i>`;

                            if (["Mexico", "Canada", "USA"].includes(team.isim)) {
                                specialClass = "text-yellow-400 font-bold";
                                starIcon = '<i class="fas fa-star text-[10px] ml-2 text-yellow-500"></i>';
                            } else if (finalPlayoffWinners.some(w => w.isim === team.isim)) {
                                specialClass = "text-green-300 font-bold";
                            }

                            teamsHtml += `
                                <div class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0">
                                    <div class="flex items-center"><span class="text-gray-500 text-xs font-mono w-4 mr-1">${i + 1}</span>${visualHtml}<span class="font-medium text-sm ${specialClass}">${team.isim} ${starIcon}</span></div>
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-gray-800 text-gray-400 border border-gray-700 min-w-[30px] text-center">${team.kita}</span>
                                </div>`;
                        });

                        card.innerHTML = `<div class="flex justify-between items-center mb-4 border-b border-yellow-600 pb-2"><h2 class="text-2xl font-bold text-yellow-500 tracking-wider">GROUP ${group.name}</h2><i class="fas fa-trophy text-yellow-700/50 text-xl"></i></div><div class="flex flex-col gap-1">${teamsHtml}</div>`;
                        container.appendChild(card);
                    }, index * 100);
                });

            } catch (error) {
                console.error(error);
                alert("An error occurred.");
                loader.style.display = 'none';
            } finally {
                setTimeout(() => { if(redrawBtn) { redrawBtn.disabled = false; redrawBtn.classList.remove('opacity-50', 'cursor-not-allowed'); } }, 1500); 
            }
        }
    </script>
</body>
</html>